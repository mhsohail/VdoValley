@{
    ViewBag.Title = "Chat";
}
<h2>Chat</h2>
<style>
    .container {
        box-shadow: 0px 0px 1px gray;
        padding: 1px;
    }
    
    #discussion-container {
        height: 350px;
        overflow-y: scroll;
    }

    #sendbutton-container {
        background-color: gray;
        height: 40px;
        padding: 0.5%;
    }

    #message {
        width:90%;
    }

    #sendmessage {
        width:9%;
    }
    
</style>
<div class="container">
    @if (@Request.IsAuthenticated)
    {
        <div id="discussion-container"><ul id="discussion"></ul></div>
        <div id="sendbutton-container">
            <input type="text" id="message" />
            <input type="button" id="sendmessage" value="Send" />
            <input type="hidden" id="displayname" value="@System.Web.HttpContext.Current.User.Identity.Name" />
        </div>
    }
    else
    {
        <span>You must 
        @Html.ActionLink("Login", "Login", "Account", new { returnUrl = Request.Url }, null)
         to chat</span>
    }
    <audio id="chatmessagesound" src="~/Sounds/chatmessage.mp3" preload="auto"></audio>
</div>
<audio id="audiotag1" src="~/Sounds/chatmessage.mp3" preload="auto"></audio>

<script type="text/javascript">
    function play_single_sound() {
        document.getElementById('audiotag1').play();
    }
</script>

@section scripts {
    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.2.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script>
        $(function () {
            // Reference the auto-generated proxy for the hub.
            var chat = $.connection.chatHub;
            // Create a function that the hub can call back to display messages.
            chat.client.addNewMessageToPage = function (name, message) {
                message = htmlEncode(message);
                name = htmlEncode(name);
                
                var regex = /[\s]*(www\.[^\s]+\.com)(?=[\s]*)/g;
                var matches = [];
                var match = regex.exec(message);
                
                while (match != null) {
                    matches.push(match[0]);
                    match = regex.exec(message);
                }
                
                if (matches != null && matches.length > 0) {
                    $(matches).each(function (i, v) {
                        message = message.replace(matches[i], "<a href='http://" + matches[i] + "/' target='_blank'>" + matches[i] + "</a>");
                    });
                }
                console.log(matches);
                // Add the message to the page.
                var li = document.createElement("LI");
                li.innerHTML = '<strong>' + name + '</strong>: ' + message;
                $('#discussion').append(li);
                play_single_sound();
            };
            // Get the user name and store it to prepend to messages.
            //$('#displayname').val(prompt('Enter your name:', ''));
            // Set initial focus to message input box.
            $('#message').focus();

            // Start the connection.
            $.connection.hub.start().done(function () {
                $('#sendmessage').click(function () {
                    if ($('#message').val() != "") {
                        // Call the Send method on the hub.
                        chat.server.send($('#displayname').val(), $('#message').val());
                        // Clear text box and reset focus for next comment.
                        $('#message').val('').focus();
                        $('#discussion-container').animate({ scrollTop: $('#discussion').height() }, 1);
                    }
                });
            });

            $("#message").keypress(function (e) {
                if (e.which == 13 || e.keyCode == 13) {
                    $("#sendmessage").click();
                    return false;
                }
            });
        });

        // This optional function html-encodes messages for display in the page.
        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }
    </script>
}